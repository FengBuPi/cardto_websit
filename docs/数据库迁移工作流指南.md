# Drizzle 数据库迁移工作流指南

## 🔄 完整工作流程

Drizzle 的迁移工作流遵循 **Schema → Migration → Apply** 的模式：

### 1️⃣ Schema 定义阶段

在 `src/schema/` 目录中定义或修改数据库表结构：

```typescript
// src/schema/users.ts
import { boolean, pgTable, serial, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  avatar: text("avatar"),
  phone: text("phone"),
  isActive: boolean("is_active").default(true),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### 2️⃣ 生成 Migration 文件

```bash
# 生成迁移文件
pnpm db:generate

# 或者使用 drizzle-kit 直接命令
npx drizzle-kit generate
```

**生成的文件结构：**

```
drizzle/
├── 0000_gray_screwball.sql    # 迁移 SQL 文件
└── meta/
    ├── _journal.json          # 迁移日志
    └── 0000_snapshot.json     # 数据库快照
```

### 3️⃣ 应用 Migration

```bash
# 应用迁移到数据库
pnpm db:migrate

# 或者使用 drizzle-kit 直接命令
npx drizzle-kit migrate
```

## 🛠️ 常用命令

### 生成迁移

```bash
pnpm db:generate
```

- 比较当前 schema 与数据库状态
- 生成 SQL 迁移文件
- 更新迁移日志

### 应用迁移

```bash
pnpm db:migrate
```

- 执行待应用的迁移文件
- 更新数据库结构
- 记录迁移历史

### 推送 Schema（开发环境）

```bash
pnpm db:push
```

- 直接将 schema 推送到数据库
- 跳过迁移文件生成
- 适用于开发环境快速迭代

## 📋 迁移最佳实践

### 1. 环境配置

确保在 `.env` 文件中设置数据库连接：

```env
NEXT_PUBLIC_SUPABASE_URL="postgresql://username:password@localhost:5432/database_name"
```

### 2. 迁移文件管理

- **不要手动修改** 生成的迁移文件
- **版本控制** 迁移文件，确保团队同步
- **备份数据库** 在生产环境应用迁移前

### 3. 开发工作流

```bash
# 1. 修改 schema 文件
# 2. 生成迁移
pnpm db:generate

# 3. 检查生成的 SQL
cat drizzle/0001_migration_name.sql

# 4. 应用迁移
pnpm db:migrate

```

### 4. 生产环境部署

```bash
# 1. 确保所有迁移文件已提交
git add drizzle/
git commit -m "Add database migration"

# 2. 部署到生产环境
# 3. 应用迁移
pnpm db:migrate
```

## 🔍 迁移文件示例

生成的迁移文件包含完整的 SQL 语句：

```sql
-- drizzle/0000_gray_screwball.sql
CREATE TABLE "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"email" text NOT NULL,
	"avatar" text,
	"phone" text,
	"is_active" boolean DEFAULT true,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "users_email_unique" UNIQUE("email")
);
```

## ⚠️ 注意事项

1. **数据安全**：生产环境迁移前务必备份数据
2. **回滚策略**：复杂迁移需要准备回滚方案
3. **团队协作**：确保团队成员使用相同的迁移文件
4. **环境隔离**：开发、测试、生产环境使用不同的数据库
