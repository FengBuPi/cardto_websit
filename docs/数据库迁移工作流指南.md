# Drizzle æ•°æ®åº“è¿ç§»å·¥ä½œæµæŒ‡å—

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

Drizzle çš„è¿ç§»å·¥ä½œæµéµå¾ª **Schema â†’ Migration â†’ Apply** çš„æ¨¡å¼ï¼š

### 1ï¸âƒ£ Schema å®šä¹‰é˜¶æ®µ

åœ¨ `src/schema/` ç›®å½•ä¸­å®šä¹‰æˆ–ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„ï¼š

```typescript
// src/schema/users.ts
import { boolean, pgTable, serial, text, timestamp } from "drizzle-orm/pg-core";

export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  avatar: text("avatar"),
  phone: text("phone"),
  isActive: boolean("is_active").default(true),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### 2ï¸âƒ£ ç”Ÿæˆ Migration æ–‡ä»¶

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
pnpm db:generate

# æˆ–è€…ä½¿ç”¨ drizzle-kit ç›´æ¥å‘½ä»¤
npx drizzle-kit generate
```

**ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„ï¼š**

```
drizzle/
â”œâ”€â”€ 0000_gray_screwball.sql    # è¿ç§» SQL æ–‡ä»¶
â””â”€â”€ meta/
    â”œâ”€â”€ _journal.json          # è¿ç§»æ—¥å¿—
    â””â”€â”€ 0000_snapshot.json     # æ•°æ®åº“å¿«ç…§
```

### 3ï¸âƒ£ åº”ç”¨ Migration

```bash
# åº”ç”¨è¿ç§»åˆ°æ•°æ®åº“
pnpm db:migrate

# æˆ–è€…ä½¿ç”¨ drizzle-kit ç›´æ¥å‘½ä»¤
npx drizzle-kit migrate
```

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

### ç”Ÿæˆè¿ç§»

```bash
pnpm db:generate
```

- æ¯”è¾ƒå½“å‰ schema ä¸æ•°æ®åº“çŠ¶æ€
- ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶
- æ›´æ–°è¿ç§»æ—¥å¿—

### åº”ç”¨è¿ç§»

```bash
pnpm db:migrate
```

- æ‰§è¡Œå¾…åº”ç”¨çš„è¿ç§»æ–‡ä»¶
- æ›´æ–°æ•°æ®åº“ç»“æ„
- è®°å½•è¿ç§»å†å²

### æ¨é€ Schemaï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
pnpm db:push
```

- ç›´æ¥å°† schema æ¨é€åˆ°æ•°æ®åº“
- è·³è¿‡è¿ç§»æ–‡ä»¶ç”Ÿæˆ
- é€‚ç”¨äºå¼€å‘ç¯å¢ƒå¿«é€Ÿè¿­ä»£

## ğŸ“‹ è¿ç§»æœ€ä½³å®è·µ

### 1. ç¯å¢ƒé…ç½®

ç¡®ä¿åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®æ•°æ®åº“è¿æ¥ï¼š

```env
NEXT_PUBLIC_SUPABASE_URL="postgresql://username:password@localhost:5432/database_name"
```

### 2. è¿ç§»æ–‡ä»¶ç®¡ç†

- **ä¸è¦æ‰‹åŠ¨ä¿®æ”¹** ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶
- **ç‰ˆæœ¬æ§åˆ¶** è¿ç§»æ–‡ä»¶ï¼Œç¡®ä¿å›¢é˜ŸåŒæ­¥
- **å¤‡ä»½æ•°æ®åº“** åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿ç§»å‰

### 3. å¼€å‘å·¥ä½œæµ

```bash
# 1. ä¿®æ”¹ schema æ–‡ä»¶
# 2. ç”Ÿæˆè¿ç§»
pnpm db:generate

# 3. æ£€æŸ¥ç”Ÿæˆçš„ SQL
cat drizzle/0001_migration_name.sql

# 4. åº”ç”¨è¿ç§»
pnpm db:migrate

```

### 4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. ç¡®ä¿æ‰€æœ‰è¿ç§»æ–‡ä»¶å·²æäº¤
git add drizzle/
git commit -m "Add database migration"

# 2. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
# 3. åº”ç”¨è¿ç§»
pnpm db:migrate
```

## ğŸ” è¿ç§»æ–‡ä»¶ç¤ºä¾‹

ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶åŒ…å«å®Œæ•´çš„ SQL è¯­å¥ï¼š

```sql
-- drizzle/0000_gray_screwball.sql
CREATE TABLE "users" (
	"id" serial PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"email" text NOT NULL,
	"avatar" text,
	"phone" text,
	"is_active" boolean DEFAULT true,
	"created_at" timestamp DEFAULT now(),
	"updated_at" timestamp DEFAULT now(),
	CONSTRAINT "users_email_unique" UNIQUE("email")
);
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®‰å…¨**ï¼šç”Ÿäº§ç¯å¢ƒè¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®
2. **å›æ»šç­–ç•¥**ï¼šå¤æ‚è¿ç§»éœ€è¦å‡†å¤‡å›æ»šæ–¹æ¡ˆ
3. **å›¢é˜Ÿåä½œ**ï¼šç¡®ä¿å›¢é˜Ÿæˆå‘˜ä½¿ç”¨ç›¸åŒçš„è¿ç§»æ–‡ä»¶
4. **ç¯å¢ƒéš”ç¦»**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸åŒçš„æ•°æ®åº“
